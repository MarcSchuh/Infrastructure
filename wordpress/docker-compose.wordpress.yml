services:
  # WordPress container
  wordpress:
    image: wordpress:${WORDPRESS_VERSION:-latest}
    container_name: ${WORDPRESS_CONTAINER_NAME:-wordpress}
    restart: ${RESTART_POLICY:-unless-stopped}
    env_file:
      - .env
    environment:
      WORDPRESS_DB_HOST: wordpress_db
      WORDPRESS_DB_USER: ${DB_USER}
      WORDPRESS_DB_PASSWORD: ${DB_PASSWORD}
      WORDPRESS_DB_NAME: ${DB_NAME}
      WORDPRESS_TABLE_PREFIX: ${WP_TABLE_PREFIX}
    volumes:
      - ${DATA_DIR}/html:/var/www/html
    depends_on:
      - wordpress_db
    networks:
      - wordpress_network
      - proxy_network
    deploy:
      resources:
        limits:
          memory: ${WORDPRESS_MEM_LIM:-1G}
          cpus: ${WORDPRESS_CPU_LIM:-0.5}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "loki"
      options:
        loki-url: "http://loki:3100/loki/api/v1/push"
        loki-pipeline-stages: |
          - json:
              expressions:
                timestamp: time
                level: level
                message: message
        loki-retries: "5"
        loki-batch-size: "400"
        loki-external-labels: "container_name={{.Name}},service=wordpress"
        loki-timeout: "10s"
        loki-buffer-size: "256MB"
        loki-queue-size: "10000"
        loki-tenant-id: "wordpress"
        loki-format: "json"

  # MariaDB container
  wordpress_db:
    image: mariadb:${MARIADB_VERSION:-latest}
    container_name: ${WORDPRESS_DB_CONTAINER_NAME:-wordpress_db}
    restart: ${RESTART_POLICY:-unless-stopped}
    env_file:
      - .env
    environment:
      MYSQL_ROOT_PASSWORD: ${ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - ${DATA_DIR}/db:/var/lib/mysql
    networks:
      - wordpress_network
    deploy:
      resources:
        limits:
          memory: ${WORDPRESS_DB_MEM_LIM:-2G}
          cpus: ${WORDPRESS_DB_CPU_LIM:-0.5}
    healthcheck:
      test: ["CMD", "mariadb-admin", "ping", "-h", "localhost", "-u", "root", "-p${ROOT_PASSWORD}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "loki"
      options:
        loki-url: "http://loki:3100/loki/api/v1/push"
        loki-pipeline-stages: |
          - json:
              expressions:
                timestamp: time
                level: level
                message: message
        loki-retries: "5"
        loki-batch-size: "400"
        loki-external-labels: "container_name={{.Name}},service=wordpress_db"
        loki-timeout: "10s"
        loki-buffer-size: "256MB"
        loki-queue-size: "10000"
        loki-tenant-id: "wordpress"
        loki-format: "json"

networks:
  wordpress_network:
    name: wordpress_network
    driver: ${NETWORK_DRIVER}
  proxy_network:
    external: true
