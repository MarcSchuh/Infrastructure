services:
  jumphost:
    image: linuxserver/openssh-server:${SSH_SERVER_VERSION:-latest}
    container_name: ${JUMPHOST_NAME:-jumphost}
    env_file:
      - .env
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-Europe/Berlin}
      - PASSWORD_ACCESS=false
      - USER_NAME=${JUMPHOST_USER:-jumphost}
    restart: ${RESTART_POLICY:-unless-stopped}
    ports:
      - "${SSH_PORT:-1234}:${SSH_PORT:-1234}"
      - "${JUMP_PORT:-5678}:${JUMP_PORT:-5678}"
    volumes:
      - ${CONFIG_DIR}:/config
    deploy:
      resources:
        limits:
          memory: ${JUMPHOST_MEM_LIM:-512M}
          cpus: ${JUMPHOST_CPU_LIM:-0.5}
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "${SSH_PORT:-1234}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "loki"
      options:
        loki-url: "http://monitoring_loki:3100/loki/api/v1/push"
        loki-retries: "5"
        loki-batch-size: "400"
        loki-external-labels: "container_name={{.Name}},service=jumphost"
        loki-timeout: "10s"
        loki-tenant-id: "jumphost"
    security_opt:
      - no-new-privileges:true

networks:
  monitoring_network:
    external: true
