services:
  # Prosody (XMPP server)
  prosody:
    image: jitsi/prosody:${JITSI_VERSION:-stable}
    container_name: ${PROSODY_CONTAINER_NAME:-jitsi_prosody}
    restart: ${RESTART_POLICY:-unless-stopped}
    ports:
      - "5222:5222"
      - "5347:5347"
      - "5280:5280"
    volumes:
      - ${CONFIG_DIR}/prosody:/config
    env_file:
      - .env
    networks:
      - jitsi_network
    logging:
      driver: "loki"
      options:
        loki-url: "http://loki:3100/loki/api/v1/push"
        loki-pipeline-stages: |
          - json:
              expressions:
                timestamp: time
                level: level
                message: message
        loki-retries: "5"
        loki-batch-size: "400"
        loki-external-labels: "container_name={{.Name}},service=prosody"
        loki-timeout: "10s"
        loki-buffer-size: "256MB"
        loki-queue-size: "10000"
        loki-tenant-id: "jitsi"
        loki-format: "json"

  # Jicofo (Focus component)
  jicofo:
    image: jitsi/jicofo:${JITSI_VERSION:-stable}
    container_name: ${JICOFO_CONTAINER_NAME:-jitsi_jicofo}
    restart: ${RESTART_POLICY:-unless-stopped}
    depends_on:
      - prosody
    volumes:
      - ${CONFIG_DIR}/jicofo:/config
    env_file:
      - .env
    networks:
      - jitsi_network
    logging:
      driver: "loki"
      options:
        loki-url: "http://loki:3100/loki/api/v1/push"
        loki-pipeline-stages: |
          - json:
              expressions:
                timestamp: time
                level: level
                message: message
        loki-retries: "5"
        loki-batch-size: "400"
        loki-external-labels: "container_name={{.Name}},service=jicofo"
        loki-timeout: "10s"
        loki-buffer-size: "256MB"
        loki-queue-size: "10000"
        loki-tenant-id: "jitsi"
        loki-format: "json"

  # JVB (Video Bridge)
  jvb:
    image: jitsi/jvb:${JITSI_VERSION:-stable}
    container_name: ${JVB_CONTAINER_NAME:-jitsi_jvb}
    restart: ${RESTART_POLICY:-unless-stopped}
    depends_on:
      - prosody
    ports:
      - "10000:10000/udp"
    volumes:
      - ${CONFIG_DIR}/jvb:/config
    env_file:
      - .env
    networks:
      - jitsi_network
    healthcheck:
      test: ["CMD", "bash", "-c", "ps aux | grep -v grep | grep -q jvb"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 15s
    logging:
      driver: "loki"
      options:
        loki-url: "http://loki:3100/loki/api/v1/push"
        loki-pipeline-stages: |
          - json:
              expressions:
                timestamp: time
                level: level
                message: message
        loki-retries: "5"
        loki-batch-size: "400"
        loki-external-labels: "container_name={{.Name}},service=jvb"
        loki-timeout: "10s"
        loki-buffer-size: "256MB"
        loki-queue-size: "10000"
        loki-tenant-id: "jitsi"
        loki-format: "json"

  # Web (Jitsi Meet web interface)
  web:
    image: jitsi/web:${JITSI_VERSION:-stable}
    container_name: ${WEB_CONTAINER_NAME:-jitsi_web}
    restart: ${RESTART_POLICY:-unless-stopped}
    depends_on:
      - prosody
      - jicofo
      - jvb
    volumes:
      - ${CONFIG_DIR}/web:/config
      - ${CONFIG_DIR}/transcripts:/usr/share/jitsi-meet/transcripts
      - ${LOG_DIR}/logs/web:/var/log/nginx
    env_file:
      - .env
    networks:
      - jitsi_network
    ports:
      - "${HTTP_PORT:-8000}:80"
      - "${HTTPS_PORT:-8443}:443"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/http-bind"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s
    logging:
      driver: "loki"
      options:
        loki-url: "http://loki:3100/loki/api/v1/push"
        loki-pipeline-stages: |
          - json:
              expressions:
                timestamp: time
                level: level
                message: message
        loki-retries: "5"
        loki-batch-size: "400"
        loki-external-labels: "container_name={{.Name}},service=web"
        loki-timeout: "10s"
        loki-buffer-size: "256MB"
        loki-queue-size: "10000"
        loki-tenant-id: "jitsi"
        loki-format: "json"

networks:
  jitsi_network:
    driver: bridge

